---
layout: post
title: 系统设计概要
categories:
  - General
published: false
---
https://gist.github.com/vasanthk/485d1c25737e8e72759f

# 基本步骤

## 1. 明确系统边界

- 用例（描述一连串的事件，合在一起会导致系统做一些有用的事情）
	- 谁会使用？
	- 他们会怎么使用？
- 限制
	- 主要确定大规模的流量和数据处理限制
	- 系统规模：每秒请求，请求类型，每秒数据写入，每秒数据读取
	- 特殊的系统要求：多线程，读取与写入的目标

## 2. 上层架构设计（抽象设计）

- 描绘重要组件和相互的连接，不需要细节。
	- 应用服务层（服务请求）
	- 列出所需的不同服务
	- 数据存储层
	- 通常一个可扩展的系统包括，Web服务器（负载均衡器）、服务（服务分区）、数据库（主从数据库集群）、缓存系统

## 3. 组件设计

- 组件和对应需要的API
- 对功能的面向对象设计
	- 将功能映射到模块：一个模块一种场景
	- 模块之间的关系
		- 某些函数必须有唯一的实例（单例）
		- 核心对象可以由许多其它对象组成（组合）
		- 一个对象是另一个对象（继承）
- 数据库架构设计

## 4. 瓶颈

- 或许系统需要负载均衡器及许多机器来处理用户请求；或者数据量太大，需要将数据库分布在多台机器上。好产生哪些优缺点？
- 数据库太慢，是否需要内存缓存？

## 5. 扩展抽象设计

- 垂直缩放
	- 添加更强的CPU、RAM
- 水平缩放
	- 添加更多的机器
- 缓存
	- 负载均衡可在数量不断增加的服务器上进行水平扩展，而缓存能够更好地利用已有资源，并使原本无法实现的产品需求变得可行
	- 应用缓存需要显示集成在应用程序代码中。通过检查值是否这缓存中，如果没有，则从数据库中检索该值。
	- 数据库缓存通常是默认的。数据库拥有一定程度的默认配置，提供一定程度的缓存和性能。针对通用用例优化这些初始设置，根据系统访问模式调整，可以大幅度提高性能。
	- 内存缓存是最为有效的。将整个数据集存储在内存中，并且对RAM的访问速度比磁盘快几个数量级。比如Memcached，Redis。
	- 预先计算结果。
	- 预先生成昂贵的索引。
	- 将经常访问的数据副本存储在更快的后端（Memcache）。
- 负载均衡
	- 可扩展的公共服务器隐藏在负债均衡器后面，负载均衡器将负载（用户请求）均匀分配到应用程序服务器组/集群上。
	- 类型：智能客户端（很难完美）、硬件负载均衡器（昂贵可靠）、软件均衡负载器（混合-适用于大多数系统）
![](assets/images/2023-10/Pasted%20image%2020231014223634.png)
- 数据库副本
	- 数据库复制将数据从一台计算机或服务器上的数据库频繁地复制到另一台计算机或服务器上数据库，以便所有用户共享相同级别的信息。将获得一个分布式数据库，用户可以访问与其任务相关的数据，而不会干扰其他人的工作。为了消除用户之间的数据歧义或不一致，数据库副本的实现为规范化。
- 数据库分区
	- 关系型数据的分区通常按行（水平）或列（垂直）分解表。
- Map-Reduce
	- 对于足够小的系统，通常可以在SQL数据库上进行临时查询，但是一旦存储的数据量或写入负载需要对数据库进行分片，这种方法无法轻松扩展，并且需要专用的从属服务器执行这些查询（设计使用专门分析大量数据的系统）。
	- 添加map-reduce层可以在合理的时间内执行数据与、或密集型操作。可以用来计算社交图中的推荐用户，或生成分析报告，例如，Hadoop、Hive、HBase。
- 平台层、服务（中台？）
	- 将平台和Web应用程序分开，可以独立扩展各部分。如果添加新的API，可以添加平台服务器，而无需为Web应用程序层添加不必要的容量。
	- 添加平台层可以在多个产品或接口复用基础架构，而不需要编写太多冗余的样板代码来处理缓存、数据库等。
![](assets/images/2023-10/Pasted%20image%2020231014223650.png)

# 系统设计的关键主题

1. 并发
线程、死锁、线程饥饿，并行化算法，一致性和连贯性。
2. 网络
IPC、TCP/IP，吞吐量、延迟。
3. 抽象
操作系统、文件系统、数据库如何工作，现代操作系统中的各个级别的缓存。
4. 实际性能
计算机所有功能的速度，包括RAM、磁盘、SSD和网络的相对性能。
5. 预估
估算，特别是粗略计算的形式，可以帮助将可能的解决方案缩小到仅可行的解决方案。只需要编写几个原型或微基准。
6. 可用性和可靠性
考虑失败情形，特别是在分布式环境中。如何设计一个系统来应对网络故障及耐用性。

# Web App系统设计注意事项

- 安全性（CORS）
- CDN
	- 内容分发网络（CDN）是一个由分布式服务器（网络）组成的系统，根据用户的地理位置、网页来源和内容分发服务器向用户分发网页和其他Web内容。
	- 该服务可有效加快高流量网站和具有全球影响力的网站的内容交付速度。CDN服务器在地理位置上距离用户越近，内容交付给用户的速度就越快。
	- CDNs还提供针对流量大幅激增的保护。
- 全文搜索
	- 使用Sphinx、Lucene、Solr - 实现快速搜索响应，不是直接搜索文本，而是搜索索引。
- 离线支持/渐进增强
	- 服务人员（运营？）
- 网络工作者
- 服务器端渲染
- 异步加载资源（延迟加载项目）
- 最小化网络请求（Http2）
- 开发人员生产力/工具
- 无障碍
- 国际化
- 响应式设计
- 浏览器兼容


# 流程

1. 理解问题和范围
	- 定义用例
	- 提出额外的功能
	- 移除超出范围的项目
	- 假设需要高可用性，添加为用例
2. 考虑限制
	- 每月的请求数
	- 每秒的请求数
	- 估计读取与写入的比例
	- 保持估计时考虑80/20法则
	- 每秒写入数据量
	- 在5年内所需的总存储量
	- 每秒读取多少数据
3. 抽象设计
	- 层（服务、数据、缓存）
	- 基础架构：负载均衡、消息传递
	- 驱动服务的任何关键算法的粗略概述
	- 考虑瓶颈并确定解决方案